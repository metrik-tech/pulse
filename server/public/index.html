<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Pulse Registry Manager</title>
		<style>
			body {
				font-family: system-ui, sans-serif;
				margin: 20px;
			}
			h1,
			h2 {
				color: #333;
			}
			form,
			.universe-list {
				margin-bottom: 20px;
			}
			input,
			button {
				padding: 10px;
				margin: 5px 0;
			}
			button {
				background-color: #4caf50;
				color: white;
				border: none;
				cursor: pointer;
			}
			button:hover {
				background-color: #45a049;
			}
			.universe-item {
				padding: 10px;
				border: 1px solid #ccc;
				margin-bottom: 10px;
			}
			.universe-item input {
				width: 80%;
				margin-right: 10px;
			}
			.universe-item button {
				padding: 5px 10px;
			}
			.delete-btn {
				background-color: red;
			}
		</style>
	</head>
	<body>
		<h1>Pulse Registry Manager</h1>

		<h2>Add Universe</h2>
		<form id="add-universe-form">
			<input type="number" id="universe-id-add" placeholder="Universe ID" required />
			<input type="text" id="api-key-add" placeholder="Open Cloud API Key" required />
			<button type="submit">Add Universe</button>
		</form>

		<h2>Universe List</h2>
		<div id="universe-list" class="universe-list"></div>

		<script>
			const API_URL = "/universe/registry"; // Base API URL

			// Check for API key in localStorage on page load
			window.onload = async function () {
				let apiKey = localStorage.getItem("apiKey");
				if (!apiKey) {
					apiKey = prompt("Please enter your API key:");
					if (apiKey) {
						localStorage.setItem("apiKey", apiKey);
					} else {
						alert("API key is required!");
						return;
					}
				}

				await listUniverses(apiKey);
			};

			// Function to list universes
			async function listUniverses(apiKey) {
				const response = await fetch(`${API_URL}/list`, {
					method: "GET",
					headers: { Authorization: `Bearer ${apiKey}` },
				});
				const result = await response.json();
				const universeList = document.getElementById("universe-list");
				universeList.innerHTML = "";

				for (const [universeId, data] of Object.entries(result)) {
					const universeItem = document.createElement("div");
					universeItem.classList.add("universe-item");
					universeItem.innerHTML = `
                <input type="number" id="universe-id-${universeId}" value="${universeId}" disabled>
                <label for="universe-id-${universeId}" ${!data.valid && 'style="color: red; font-weight: bold;"'}>${
						data.valid ? "Open Cloud API Key is active" : "Open Cloud API Key is inactive. Please edit!"
					}</label>
                <input type="text" placeholder="Update Open Cloud API Key">
                <button class="update-btn">Update</button>
                <button class="delete-btn">Delete</button>
            `;

					// Update universe handler
					const updateBtn = universeItem.querySelector(".update-btn");
					updateBtn.addEventListener("click", async () => {
						const newApiKey = universeItem.querySelector('input[type="text"]:nth-child(3)').value;
						if (newApiKey) {
							await updateUniverse(universeId, newApiKey, apiKey);
						} else {
							alert("Please provide a new API key.");
						}
					});

					// Delete universe handler
					const deleteBtn = universeItem.querySelector(".delete-btn");
					deleteBtn.addEventListener("click", async () => {
						await deleteUniverse(universeId, apiKey);
					});

					universeList.appendChild(universeItem);
				}
			}

			// Function to add universe
			document.getElementById("add-universe-form").addEventListener("submit", async (event) => {
				event.preventDefault();
				const universeId = document.getElementById("universe-id-add").value;
				const apiKey = localStorage.getItem("apiKey");
				const openCloudApiKey = document.getElementById("api-key-add").value;
				const response = await fetch(`${API_URL}/add`, {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						Authorization: `Bearer ${apiKey}`,
					},
					body: JSON.stringify({ universeId, openCloudApiKey }),
				});
				const result = await response.json();
				alert(JSON.stringify(result, null, 2));
				await listUniverses(apiKey); // Reload the list
			});

			// Function to update a universe
			async function updateUniverse(universeId, newApiKey, apiKey) {
				const response = await fetch(`${API_URL}/update`, {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						Authorization: `Bearer ${apiKey}`,
					},
					body: JSON.stringify({ universeId, openCloudApiKey: newApiKey }),
				});
				const result = await response.json();
				alert(JSON.stringify(result, null, 2));
				await listUniverses(apiKey); // Reload the list
			}

			// Function to delete a universe
			async function deleteUniverse(universeId, apiKey) {
				const response = await fetch(`${API_URL}/remove`, {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						Authorization: `Bearer ${apiKey}`,
					},
					body: JSON.stringify({ universeId }),
				});
				const result = await response.json();
				alert(JSON.stringify(result, null, 2));
				await listUniverses(apiKey); // Reload the list
			}
		</script>
	</body>
</html>
